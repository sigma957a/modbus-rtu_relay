# üèÜ –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Modbus RTU Relay –∏ Waveshare Gateway

**–î–∞—Ç–∞:** 2024-11-24  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ  
**–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:** Raspberry Pi 5, Waveshare 4-CH RS485 TO POE ETH (B), Modbus RTU Relay 32CH

---

## üìñ 1. –ò—Å—Ç–æ—Ä–∏—è —É—Å–ø–µ—Ö–∞: –ö–∞–∫ –º—ã —ç—Ç–æ —Å–¥–µ–ª–∞–ª–∏

–≠—Ç–æ—Ç –æ—Ç—á–µ—Ç –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤–µ—Å—å –ø—É—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, –≤–∫–ª—é—á–∞—è –≤—Å–µ –æ—à–∏–±–∫–∏, —Ç—É–ø–∏–∫–∏ –∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.

### –ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç (The "Secret Sauce") üå∂Ô∏è

–ì–ª–∞–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ —É—Å–ø–µ—Ö–∞ ‚Äî **–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ VirCOM**, –∫–æ—Ç–æ—Ä—ã–π –º—ã –Ω–∞—à–ª–∏ –æ–ø—ã—Ç–Ω—ã–º –ø—É—Ç–µ–º:

1.  **–†–µ–∂–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:** –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–µ–ª–∞–ª–∏—Å—å, –∫–æ–≥–¥–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –±—ã–ª–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ **STOP** (–ö—Ä–∞—Å–Ω–∞—è –∫–Ω–æ–ø–∫–∞).
2.  **–¢–∏—Ä–∞–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫:**
    *   –ù–∞—Å—Ç—Ä–æ–∏–ª–∏ **–æ–¥–∏–Ω –ø–æ—Ä—Ç** (Port 1) –∏–¥–µ–∞–ª—å–Ω–æ.
    *   –°–¥–µ–ª–∞–ª–∏ —ç—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ **–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**.
    *   –ü—Ä–∏–º–µ–Ω–∏–ª–∏ –∏—Ö –∫–æ **–≤—Å–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–º 3 –ø–æ—Ä—Ç–∞–º**.
3.  **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:** –ù–∞–∂–∞–ª–∏ **Modify Setting** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Ä—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ.
4.  **–ó–∞–ø—É—Å–∫:** –í—ã—à–ª–∏ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏ –Ω–∞–∂–∞–ª–∏ **–ó–µ–ª–µ–Ω—É—é –∫–Ω–æ–ø–∫—É START**.

–ò–º–µ–Ω–Ω–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å **STOP ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ‚Üí Modify ‚Üí START** –∑–∞—Å—Ç–∞–≤–∏–ª–∞ Gateway —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!

---

## üõ†Ô∏è 2. –î–µ—Ç–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è VirCOM

### 2.1 –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (Device Settings)
–≠—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ TCP –≤ RTU.

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ |
|----------|----------|------------------|
| **IP Mode** | Static | –ß—Ç–æ–±—ã IP –Ω–µ –º–µ–Ω—è–ª—Å—è (192.168.1.254) |
| **Port** | 502 | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ä—Ç Modbus TCP |
| **Work Mode** | TCP Server | RPI5 –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Gateway, –∞ –Ω–µ –Ω–∞–æ–±–æ—Ä–æ—Ç |
| **Modbus TCP To RTU** | **‚úÖ –í–∫–ª—é—á–µ–Ω–æ** | **–ö–†–ò–¢–ò–ß–ù–û!** –ë–µ–∑ —ç—Ç–æ–≥–æ Gateway –Ω–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª |
| **Enable Multi-host** | **‚úÖ –í–∫–ª—é—á–µ–Ω–æ** | **–ö–†–ò–¢–ò–ß–ù–û!** –ü–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ Slave ID |

### 2.2 –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—Ä—Ç–∞ RS485 (Serial Settings)
–î–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —Å–∞–º–æ–≥–æ —Ä–µ–ª–µ.

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| Baud Rate | 9600 |
| Data Bits | 8 |
| Parity | None |
| Stop Bits | 1 |

---

## üöß 3. –•—Ä–æ–Ω–æ–ª–æ–≥–∏—è –ø—Ä–æ–±–ª–µ–º –∏ —Ä–µ—à–µ–Ω–∏–π

–í –ø—Ä–æ—Ü–µ—Å—Å–µ –º—ã —Å—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å —Å —Ä—è–¥–æ–º –ø—Ä–æ–±–ª–µ–º. –í–æ—Ç –∫–∞–∫ –º—ã –∏—Ö —Ä–µ—à–∏–ª–∏:

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 1: "ModbusIOException: No response received"
**–°–∏–º–ø—Ç–æ–º—ã:** –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –µ—Å—Ç—å, –Ω–æ —Ä–µ–ª–µ –º–æ–ª—á–∏—Ç.
**–ü—Ä–∏—á–∏–Ω–∞:** –í VirCOM –Ω–µ –±—ã–ª–∞ –≤–∫–ª—é—á–µ–Ω–∞ –≥–∞–ª–æ—á–∫–∞ **"Modbus TCP To RTU"** –∏–ª–∏ **"Enable Multi-host"**. Gateway —Ä–∞–±–æ—Ç–∞–ª –∫–∞–∫ "–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –º–æ—Å—Ç", –Ω–æ –Ω–µ –ø–µ—Ä–µ–≤–æ–¥–∏–ª —è–∑—ã–∫ TCP –Ω–∞ —è–∑—ã–∫ RS485.
**–†–µ—à–µ–Ω–∏–µ:** –í–∫–ª—é—á–µ–Ω–∏–µ —ç—Ç–∏—Ö –≥–∞–ª–æ—á–µ–∫ –≤ VirCOM.

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 2: 0 –í–æ–ª—å—Ç –Ω–∞ –∫–ª–µ–º–º–∞—Ö A –∏ B
**–°–∏–º–ø—Ç–æ–º—ã:** –ú—É–ª—å—Ç–∏–º–µ—Ç—Ä –ø–æ–∫–∞–∑—ã–≤–∞–ª 0–í –¥–∞–∂–µ –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞.
**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:** –ú—ã –¥—É–º–∞–ª–∏, —á—Ç–æ RS485 –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.
**–†–µ–∞–ª—å–Ω–æ—Å—Ç—å:** RS485 —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –∏–º–ø—É–ª—å—Å–∞–º–∏ (~100 –º–∫—Å). –û–±—ã—á–Ω—ã–π –º—É–ª—å—Ç–∏–º–µ—Ç—Ä –ø—Ä–æ—Å—Ç–æ –Ω–µ —É—Å–ø–µ–≤–∞–µ—Ç –∏—Ö –∑–∞–º–µ—Ç–∏—Ç—å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É—Å—Ä–µ–¥–Ω–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (0–í).
**–í—ã–≤–æ–¥:** 0–í –≤ –ø–æ–∫–æ–µ ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞. –ù–∞–ª–∏—á–∏–µ —É—Å–ø–µ—à–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –≤ –ª–æ–≥–µ (`WriteSingleCoilResponse`) ‚Äî –ª—É—á—à–µ–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ —Ä–∞–±–æ—Ç—ã.

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 3: –°–µ—Ç–µ–≤–∞—è –∏–∑–æ–ª—è—Ü–∏—è
**–°–∏–º–ø—Ç–æ–º—ã:** –ù–µ —É–¥–∞–≤–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ Mac.
**–ü—Ä–∏—á–∏–Ω–∞:** Mac (192.168.0.x) –∏ Gateway (192.168.1.x) –±—ã–ª–∏ –≤ —Ä–∞–∑–Ω—ã—Ö –ø–æ–¥—Å–µ—Ç—è—Ö –±–µ–∑ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏.
**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ —Å **Raspberry Pi 5**, –∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–ª –¥–æ—Å—Ç—É–ø –∫ –æ–±–µ–∏–º –ø–æ–¥—Å–µ—Ç—è–º.

---

## üß™ 4. –§–∏–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã

–ú—ã –ø—Ä–æ–≤–µ–ª–∏ —Å–µ—Ä–∏—é –∂–µ—Å—Ç–∫–∏—Ö —Ç–µ—Å—Ç–æ–≤, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è –≤ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏.

### –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –ø–æ—Ä—Ç–æ–≤ Gateway
–°–∫—Ä–∏–ø—Ç: `test_all_gateway_ports.py`
*   **–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ Gateway –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—ã –Ω–∞ –≤—Å–µ 4 –ø–æ—Ä—Ç–∞.
*   **–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í—Å–µ 4 –ø–æ—Ä—Ç–∞ (Slave ID 1, 2, 3, 4) —É—Å–ø–µ—à–Ω–æ –æ—Ç–≤–µ—Ç–∏–ª–∏. –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã LINK1-LINK4 –º–æ—Ä–≥–∞–ª–∏ –ø–æ –æ—á–µ—Ä–µ–¥–∏.

### –¢–µ—Å—Ç 2: –ü–æ–ª–Ω—ã–π –ø—Ä–æ–≥–æ–Ω 32 –∫–∞–Ω–∞–ª–æ–≤
–°–∫—Ä–∏–ø—Ç: `test_relay_sequence.py`
*   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Ä–µ–ª–µ.
*   **–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í—Å–µ 32 —Ä–µ–ª–µ —â–µ–ª–∫–Ω—É–ª–∏ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏.

### –¢–µ—Å—Ç 3: –°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç (The Ultimate Test) üöÄ
*   **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:** –ó–∞–¥–µ—Ä–∂–∫–∞ 0.3 —Å–µ–∫, 20 –ø–æ–ª–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤.
*   **–í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π:** 1280 –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π.
*   **–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ù–∏ –æ–¥–Ω–æ–π –æ—à–∏–±–∫–∏. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ.

---

## üöÄ 5. –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å (Quick Start)

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
```bash
ssh sigma@rpi5
cd ~/telegram-support-bot
source bot_env/bin/activate
```

### –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
```bash
python3 app/vending_ui/test_relay_sequence.py
# –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º 2 (Gateway)
```

### –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞
–í—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ –≤–µ—Ç–∫—É `modbus-rtu-gateway`:
*   `docs/modbus_relay_final_report.md` ‚Äî —ç—Ç–æ—Ç —Ñ–∞–π–ª
*   `docs/modbus_relay_setup_updated.md` ‚Äî —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
*   `app/vending_ui/test_relay_sequence.py` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç

---

**–ò—Ç–æ–≥:** –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞, –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ. üéâ
